<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retro 144p Converter —</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; padding: 20px; }
    .card { background: #222; border-radius: 8px; padding: 20px; max-width: 800px; margin: auto; }
    label, select, input, button { display: block; margin-top: 12px; }
    input, select { padding: 6px; width: 100%; max-width: 300px; }
    button { padding: 10px; background: #28a; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .progress { margin-top: 12px; height: 8px; background: #444; border-radius: 4px; overflow: hidden; }
    .bar { width: 0%; height: 100%; background: #28a; transition: width 0.2s; }
    video { margin-top: 12px; max-width: 100%; background: black; }
    .status { margin-top: 8px; font-size: 14px; }
    .error { color: #f88; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Retro 144p Converter — 修正版 (CDN パス修正)</h2>
    <label>動画ファイル <input id="file" type="file" accept="video/*"></label>
    <label>解像度
      <select id="targetRes">
        <option value="256:144">256×144 (144p)</option>
        <option value="320:180">320×180</option>
        <option value="426:240">426×240</option>
      </select>
    </label>
    <label>ビットレート <input id="bitrate" type="text" value="200k"></label>
    <button id="startBtn">変換開始</button>
    <button id="downloadBtn" disabled>ダウンロード</button>
    <div class="progress"><div id="bar" class="bar"></div></div>
    <div id="status" class="status"></div>
    <div id="previewArea" style="display:none;">
      <video id="preview" controls playsinline></video>
      <div id="meta"></div>
    </div>
  </div>

  <!-- ここで UMD 形式の CDN スクリプトを読み込む -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js"></script>
  <script type="module">
    // UMD 形式で読み込んであるなら、`FFmpeg` グローバルオブジェクトから取得
    const { createFFmpeg, fetchFile } = FFmpeg;

    const ffmpeg = createFFmpeg({ log: true });
    let isLoaded = false;

    const fileInput = document.getElementById("file");
    const startBtn = document.getElementById("startBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusEl = document.getElementById("status");
    const bar = document.getElementById("bar");
    const preview = document.getElementById("preview");
    const previewArea = document.getElementById("previewArea");
    const metaEl = document.getElementById("meta");
    const targetRes = document.getElementById("targetRes");
    const bitrateInput = document.getElementById("bitrate");

    function logStatus(msg) {
      statusEl.textContent = msg;
    }
    function logError(msg) {
      statusEl.innerHTML = `<span class="error">${msg}</span>`;
    }

    ffmpeg.setProgress(({ ratio }) => {
      if (ratio != null) {
        bar.style.width = `${(ratio * 100).toFixed(2)}%`;
      }
    });
    ffmpeg.setLogger(({ type, message }) => {
      console.log(`[ffmpeg ${type}] ${message}`);
    });

    async function loadFFmpegCore() {
      if (isLoaded) return;
      logStatus("ffmpeg コアをロード中...");
      try {
        // load() を呼ぶだけで core が自動的に読み込まれる UMD 形式の振る舞いを期待
        await ffmpeg.load();
        isLoaded = true;
        logStatus("ffmpeg コアのロード完了");
      } catch (err) {
        console.error("ffmpeg.load error:", err);
        logError("ffmpeg コアのロードに失敗: " + err.message);
        throw err;
      }
    }

    startBtn.addEventListener("click", async () => {
      const f = fileInput.files[0];
      if (!f) {
        alert("動画を選択してください");
        return;
      }
      startBtn.disabled = true;
      downloadBtn.disabled = true;
      bar.style.width = "0%";
      previewArea.style.display = "none";

      try {
        await loadFFmpegCore();

        logStatus("入力ファイル読み込み中...");
        const inName = "in" + Date.now() + "_" + f.name;
        const outName = "out_retro.mp4";
        const data = await fetchFile(f);
        ffmpeg.FS("writeFile", inName, data);

        const [w, h] = targetRes.value.split(":").map(s => parseInt(s));
        const bitrate = bitrateInput.value || "200k";

        const vf = [
          `scale=${w}:${h}`,
          `eq=contrast=0.95:brightness=-0.02:saturation=0.65`,
          `hue=h=5:s=0.95`,
          `noise=alls=20:allf=t`,
          `format=yuv420p`
        ].join(",");

        const args = [
          "-i", inName,
          "-vf", vf,
          "-b:v", bitrate,
          "-c:v", "libx264",
          "-preset", "veryfast",
          "-movflags", "faststart",
          "-c:a", "aac",
          "-b:a", "96k",
          "-y",
          outName
        ];

        logStatus("変換中...");
        await ffmpeg.run(...args);

        logStatus("出力取得中...");
        const outData = ffmpeg.FS("readFile", outName);
        const blob = new Blob([outData.buffer], { type: "video/mp4" });
        const url = URL.createObjectURL(blob);

        preview.src = url;
        preview.load();
        previewArea.style.display = "block";
        metaEl.textContent = `解像度: ${w}×${h}, ビットレート: ${bitrate}, サイズ: ${(blob.size / 1024 / 1024).toFixed(2)} MB`;

        downloadBtn.disabled = false;
        downloadBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = url;
          a.download = outName;
          a.click();
        };

        logStatus("変換完了");
      } catch (err) {
        console.error("変換中にエラー:", err);
        logError("変換エラー: " + (err.message || err));
      } finally {
        startBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
