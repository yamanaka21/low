<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Retro 144p Video Converter</title>
  <style>
    body{font-family:sans-serif;background:#0e141f;color:#e6edf5;padding:20px;}
    h1{font-size:20px;margin-bottom:10px;}
    .card{background:#141d2a;border:1px solid #263448;padding:20px;border-radius:12px;max-width:800px;margin:auto;}
    input,button,select{margin:5px 0;padding:8px;border-radius:6px;border:none;}
    button{background:#2563eb;color:white;cursor:pointer;font-weight:bold;}
    button:disabled{opacity:0.5;cursor:not-allowed;}
    video{max-width:100%;margin-top:10px;border-radius:6px;background:black;}
    .progress{height:10px;background:#1e293b;border-radius:5px;overflow:hidden;margin-top:10px;}
    .bar{height:100%;width:0%;background:#3b82f6;transition:width .2s;}
    .note{font-size:13px;color:#94a3b8;margin-top:10px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸï¸ Retro 144p Video Converter</h1>
    <p>å‹•ç”»ã‚’ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ä½è§£åƒåº¦ï¼ˆ144pï¼‰ï¼†ãƒ¬ãƒˆãƒ­é¢¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¾ã™ã€‚</p>

    <input type="file" id="file" accept="video/*"><br>
    <select id="resolution">
      <option value="256:144">144p (256x144)</option>
      <option value="426:240">240p (426x240)</option>
      <option value="320:180">180p (320x180)</option>
    </select>
    <br>
    <button id="convert">å¤‰æ›é–‹å§‹</button>
    <button id="download" disabled>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <div id="status"></div>
    <div class="progress"><div id="bar" class="bar"></div></div>

    <video id="output" controls></video>
    <p class="note">â€» åˆå›ã¯ ffmpeg ã‚³ã‚¢ (~25MB) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
  </div>

  <script type="module">
    import { createFFmpeg, fetchFile } from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.9/dist/ffmpeg.min.mjs";

    const ffmpeg = createFFmpeg({
      log: true,
      corePath: "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.9/dist/ffmpeg-core.js"
    });

    const fileInput = document.getElementById("file");
    const convertBtn = document.getElementById("convert");
    const downloadBtn = document.getElementById("download");
    const status = document.getElementById("status");
    const bar = document.getElementById("bar");
    const video = document.getElementById("output");
    const resolution = document.getElementById("resolution");

    let outUrl = null;

    ffmpeg.setProgress(({ ratio }) => {
      bar.style.width = (ratio * 100).toFixed(1) + "%";
    });

    convertBtn.onclick = async () => {
      const file = fileInput.files[0];
      if (!file) return alert("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

      convertBtn.disabled = true;
      status.textContent = "åˆæœŸåŒ–ä¸­...";
      if (!ffmpeg.isLoaded()) await ffmpeg.load();

      status.textContent = "å¤‰æ›ä¸­...";
      const inName = "input.mp4";
      const outName = "output.mp4";

      ffmpeg.FS("writeFile", inName, await fetchFile(file));

      const [w, h] = resolution.value.split(":");

      const vf = [
        `scale=${w}:${h}`,
        `eq=contrast=0.9:brightness=-0.02:saturation=0.6`,
        `hue=h=5:s=0.9`,
        `noise=alls=15:allf=t`,
        `format=yuv420p`
      ].join(",");

      await ffmpeg.run(
        "-i", inName,
        "-vf", vf,
        "-preset", "veryfast",
        "-b:v", "200k",
        "-c:v", "libx264",
        "-c:a", "aac",
        "-movflags", "faststart",
        outName
      );

      const data = ffmpeg.FS("readFile", outName);
      const blob = new Blob([data.buffer], { type: "video/mp4" });
      if (outUrl) URL.revokeObjectURL(outUrl);
      outUrl = URL.createObjectURL(blob);
      video.src = outUrl;
      video.load();
      downloadBtn.disabled = false;
      downloadBtn.onclick = () => {
        const a = document.createElement("a");
        a.href = outUrl;
        a.download = "retro_144p.mp4";
        a.click();
      };
      status.textContent = "å®Œäº†ï¼";
      convertBtn.disabled = false;
    };
  </script>
</body>
</html>
